<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fluxo de Mensagens</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f2f2f2;
    }

    .container {
      background-color: white;
      max-width: 500px;
      margin: 40px auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    h1 {
      text-align: center;
      color: #007bff;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }

    nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    nav button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    section {
      display: none;
    }

    section.active {
      display: block;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button.copiar {
      background-color: green;
      color: white;
      font-weight: bold;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #resultadoPesquisa {
      resize: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Fluxo de Mensagens</h1>

    <nav>
      <button onclick="mostrarSecao('pesquisar')">Pesquisar</button>
      <button onclick="mostrarSecao('adicionar')">Adicionar</button>
      <button onclick="mostrarSecao('alterar')">Alterar</button>
    </nav>

    <!-- Importar CSV -->
    <div style="margin: 10px 0;">
      <label><strong>Importar CSV:</strong></label>
      <input type="file" id="importarCsv" accept=".csv" onchange="importarCSV()" />
    </div>

    <!-- Pesquisar -->
    <section id="pesquisar" class="active">
      <label for="pesqAtalho">Atalho:</label>
      <input id="pesqAtalho" oninput="pesquisarMensagem()" placeholder="Digite o atalho para pesquisar" autocomplete="off" />
      
      <div style="margin-top: 10px;">
        <textarea id="resultadoPesquisa" rows="4" readonly></textarea>
        <div style="text-align: center; margin-top: 10px;">
          <button onclick="copiarMensagem()" class="copiar">Copiar</button>
        </div>
      </div>
    </section>

    <!-- Adicionar -->
    <section id="adicionar">
      <label for="novoAtalho">Novo atalho:</label>
      <input id="novoAtalho" placeholder="Digite o novo atalho" autocomplete="off" />
      <label for="novaMensagem">Mensagem:</label>
      <textarea id="novaMensagem" rows="4" placeholder="Digite a mensagem"></textarea>
      <button onclick="adicionarMensagem()">Adicionar Mensagem</button>
      <div id="msgAdicionar" style="margin-top:10px;color:green;"></div>
    </section>

    <!-- Alterar -->
    <section id="alterar">
      <label for="altAtalho">Atalho existente:</label>
      <input id="altAtalho" placeholder="Digite o atalho" autocomplete="off" />
      <label for="altMensagem">Nova mensagem:</label>
      <textarea id="altMensagem" rows="4" placeholder="Digite a nova mensagem"></textarea>
      <button onclick="alterarMensagem()">Alterar Mensagem</button>
      <div id="msgAlterar" style="margin-top:10px;color:green;"></div>
    </section>
  </div>

  <script>
    const secoes = document.querySelectorAll("section");

    function mostrarSecao(id) {
      secoes.forEach(secao => secao.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    async function pesquisarMensagem() {
      const atalho = document.getElementById("pesqAtalho").value;
      if (!atalho) {
        document.getElementById("resultadoPesquisa").value = "";
        return;
      }

      const res = await fetch(`/api/atalho/${encodeURIComponent(atalho)}`);
      const data = await res.json();
      document.getElementById("resultadoPesquisa").value = data.mensagem || "Mensagem não encontrada.";
    }

    async function adicionarMensagem() {
      const atalho = document.getElementById("novoAtalho").value;
      const mensagem = document.getElementById("novaMensagem").value;

      const res = await fetch("/api/atalho", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ atalho, mensagem }),
      });

      const data = await res.json();
      document.getElementById("msgAdicionar").textContent = data.success || data.error || "Erro.";
      document.getElementById("novoAtalho").value = "";
      document.getElementById("novaMensagem").value = "";
    }

    async function alterarMensagem() {
      const atalho = document.getElementById("altAtalho").value;
      const novaMensagem = document.getElementById("altMensagem").value;

      const res = await fetch(`/api/atalho/${encodeURIComponent(atalho)}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mensagem: novaMensagem }),
      });

      const data = await res.json();
      document.getElementById("msgAlterar").textContent = data.success || data.error || "Erro.";
      document.getElementById("altAtalho").value = "";
      document.getElementById("altMensagem").value = "";
    }

    function copiarMensagem() {
      const textarea = document.getElementById("resultadoPesquisa");
      textarea.select();
      document.execCommand("copy");
      alert("Mensagem copiada!");
    }

    async function importarCSV() {
      const input = document.getElementById('importarCsv');
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function (e) {
        const linhas = e.target.result.split('\n');
        const resultados = [];

        for (let i = 0; i < linhas.length; i++) {
          const linha = linhas[i].trim();
          if (!linha) continue;

          const [atalho, ...mensagemArray] = linha.split(',');
          if (!atalho || mensagemArray.length === 0) continue;

          const mensagem = mensagemArray.join(',').trim();

          try {
            const res = await fetch('/api/atalho', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ atalho: atalho.trim(), mensagem })
            });

            if (res.ok) {
              resultados.push(`✅ "${atalho}" importado.`);
            } else {
              const data = await res.json();
              resultados.push(`❌ Erro "${atalho}": ${data.error || 'Erro desconhecido'}`);
            }
          } catch (err) {
            resultados.push(`❌ Falha "${atalho}": ${err.message}`);
          }
        }

        alert(resultados.join('\n'));
        input.value = '';
      };

      reader.readAsText(file);
    }
  </script>
</body>
</html>
